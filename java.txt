/*
 stateManager.js - salva/restaura:
  - sidebar (collapsed/expanded)
  - theme (light/dark)
  Mantém estado entre páginas via localStorage.
*/

(function(){
  const sidebar = document.getElementById('sidebar');
  const toggleSidebar = document.getElementById('toggleSidebar');
  const themeToggle = document.getElementById('themeToggle');

  const SIDEBAR_KEY = 'sidebarState'; // values: 'collapsed'|'expanded'
  const THEME_KEY = 'theme'; // values: 'light'|'dark'

  // ----- Aplicar estado salvo (no carregamento) -----
  function applySavedState(){
    const savedSidebar = localStorage.getItem(SIDEBAR_KEY);
    const savedTheme = localStorage.getItem(THEME_KEY);

    // Tema
    if(savedTheme){
      document.body.classList.remove('light','dark');
      document.body.classList.add(savedTheme);
      themeToggle.setAttribute('aria-pressed', savedTheme === 'dark');
    } else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initial = prefersDark ? 'dark' : 'light';
      document.body.classList.add(initial);
      localStorage.setItem(THEME_KEY, initial);
      themeToggle.setAttribute('aria-pressed', initial === 'dark');
    }

    // Sidebar: prioridade para preferência do usuário; se não tiver, adapta para tela pequena
    if(savedSidebar){
      sidebar.classList.remove('collapsed','expanded');
      sidebar.classList.add(savedSidebar === 'collapsed' ? 'collapsed' : 'expanded');
      sidebar.setAttribute('aria-hidden', savedSidebar === 'collapsed' ? 'true' : 'false');
      toggleSidebar.setAttribute('aria-pressed', savedSidebar === 'collapsed');
    } else {
      const smallScreen = window.innerWidth <= 800;
      const state = smallScreen ? 'collapsed' : 'expanded';
      sidebar.classList.remove('collapsed','expanded');
      sidebar.classList.add(state);
      localStorage.setItem(SIDEBAR_KEY, state);
      sidebar.setAttribute('aria-hidden', state === 'collapsed' ? 'true' : 'false');
      toggleSidebar.setAttribute('aria-pressed', state === 'collapsed');
    }
  }

  // ----- Alterna e salva sidebar -----
  function toggleSidebarState(){
    const isCollapsed = sidebar.classList.contains('collapsed');
    if(isCollapsed){
      sidebar.classList.remove('collapsed'); sidebar.classList.add('expanded');
      localStorage.setItem(SIDEBAR_KEY, 'expanded');
      sidebar.setAttribute('aria-hidden','false');
      toggleSidebar.setAttribute('aria-pressed', 'false');
    } else {
      sidebar.classList.remove('expanded'); sidebar.classList.add('collapsed');
      localStorage.setItem(SIDEBAR_KEY, 'collapsed');
      sidebar.setAttribute('aria-hidden','true');
      toggleSidebar.setAttribute('aria-pressed', 'true');
    }
  }

  // ----- Alterna e salva tema -----
  function toggleTheme(){
    if(document.body.classList.contains('light')){
      document.body.classList.remove('light'); document.body.classList.add('dark');
      localStorage.setItem(THEME_KEY, 'dark');
      themeToggle.setAttribute('aria-pressed', 'true');
    } else {
      document.body.classList.remove('dark'); document.body.classList.add('light');
      localStorage.setItem(THEME_KEY, 'light');
      themeToggle.setAttribute('aria-pressed', 'false');
    }
  }

  // ----- Eventos e inicialização -----
  toggleSidebar.addEventListener('click', () => {
    toggleSidebarState();
  });

  themeToggle.addEventListener('click', toggleTheme);

  // Ajuste ao redimensionar: se o usuário NÂO explicitou escolha, aplica comportamento responsivo
  let userToggledSidebar = localStorage.getItem('sidebarUserToggled') === 'true';
  toggleSidebar.addEventListener('click', () => {
    localStorage.setItem('sidebarUserToggled', 'true');
    userToggledSidebar = true;
  });

  window.addEventListener('resize', () => {
    const smallScreen = window.innerWidth <= 800;
    const savedSidebar = localStorage.getItem(SIDEBAR_KEY);
    if(!userToggledSidebar && !savedSidebar){
      const state = smallScreen ? 'collapsed' : 'expanded';
      sidebar.classList.remove('collapsed','expanded');
      sidebar.classList.add(state);
      localStorage.setItem(SIDEBAR_KEY, state);
      sidebar.setAttribute('aria-hidden', state === 'collapsed' ? 'true' : 'false');
      toggleSidebar.setAttribute('aria-pressed', state === 'collapsed');
    }
  });

  // Inicializa
  applySavedState();
  console.info('State manager inicializado. Sidebar:', localStorage.getItem(SIDEBAR_KEY), 'Theme:', localStorage.getItem(THEME_KEY));
})();
